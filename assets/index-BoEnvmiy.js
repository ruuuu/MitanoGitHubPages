(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const c of s)if(c.type==="childList")for(const i of c.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const c={};return s.integrity&&(c.integrity=s.integrity),s.referrerPolicy&&(c.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?c.credentials="include":s.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(s){if(s.ep)return;s.ep=!0;const c=n(s);fetch(s.href,c)}})();const _=(t,e)=>{let n;return(...r)=>{clearTimeout(n),n=setTimeout(()=>{t(...r)},e)}},w=()=>{const t=document.querySelector(".header"),e=document.body;let n=t.offsetHeight;const r=()=>{n=t.offsetHeight},s=()=>{window.scrollY>200?(t.classList.add("header--fixed"),e.style.paddingTop=`${n}px`):(t.classList.remove("header--fixed"),e.style.paddingTop="0")};window.addEventListener("scroll",_(s,250)),window.addEventListener("resize",_(r,100))},u="https://diamond-trusting-hardcover.glitch.me",S=t=>{if(Object.keys(t).length===0)return"";const e=new URLSearchParams;return Object.entries(t).forEach(([n,r])=>{e.append(n,r)}),`?${e.toString()}`},L=async(t={})=>{try{const e=await fetch(`${u}/api/products${S(t)}`);if(!e.ok)throw new Error(`HTTP status is ${e.status}`);const n=await e.json();return console.log("products ",n),n}catch(e){return console.error(`Ошибка при получении данных: ${e}`),[]}},x=async t=>{try{const e=await fetch(`${u}/api/orders`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error(`HTTP status is ${e.status}`);return await e.json()}catch(e){console.error(`Ошибка отправки данных: ${e}`)}};class v{constructor(){this.observers=[]}subscribe(e){this.observers.push(e)}notifyObservers(){this.observers.forEach(e=>e())}}class q extends v{constructor(){super(),this.products=[],this.categories=new Set,this.error=null,this.loading=!1}fetchProducts(){console.log("this of ProductStore ",this);const e=this;return async n=>{try{e.error=null,e.loading=!0,e.setProducts(await L(n)),e.loading=!1,e.notifyObservers()}catch(r){e.error=r,e.setProducts([]),e.loading=!1,e.notifyObservers()}}}getProducts(){return this.products}getLoading(){return this.loading}setProducts(e){this.products=e,this.updateCategories(e),this.notifyObservers()}getCategories(){return this.categories}updateCategories(e){this.categories.clear(),e.forEach(n=>{n.categories&&n.categories.forEach(r=>{this.categories.add(r)})}),this.notifyObservers()}}class E extends v{constructor(){super(),this.cart=[]}async init(){await this.registerCart(),await this.fetchCart(),console.log("this of CartStore ",this)}async registerCart(){try{const e=await fetch(`${u}/api/cart/register`,{method:"POST",credentials:"include"});if(!e.ok)throw new Error(`ошибка запроса: ${e.status}`)}catch(e){console.error(e)}}getCart(){return this.cart}async fetchCart(){try{const e=await fetch(`${u}/api/cart`,{method:"GET",credentials:"include"});if(!e.ok)throw new Error(`ошибка запроса: ${e.status}`);const n=await e.json();this.cart=n,this.notifyObservers()}catch(e){console.error(e)}}async postCart({id:e,quantity:n}){try{const r=await fetch(`${u}/api/cart/items`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({productId:e,quantity:n})});if(!r.ok)throw new Error(`ошибка запроса: ${r.status}`);const s=await r.json();this.cart=s,this.notifyObservers()}catch(r){console.error(r)}}async addProductCart(e){await this.postCart({id:e,quantity:1})}clearCart(){this.cart=[],this.notifyObservers()}}const l=new q,a=new E,h=(t,e=0)=>{const n=t.getBoundingClientRect(),r=window.innerWidth;n.left<0?(t.style.left="0",t.style.right="auto",t.style.transform="translateX(0)"):n.right>r?(t.style.left="auto",t.style.right="0",t.style.transform="translateX(0)"):(t.style.left="50%",t.style.right="auto",t.style.transform="translateX(-50%)");const s=t.getBoundingClientRect();(s.left<0||s.right>r)&&e<3&&(e++,h(t,e))},P=()=>{const t=document.querySelectorAll(".choices");t.forEach(e=>{const n=e.querySelector(".choices__btn"),r=e.querySelector(".choices__box");n.addEventListener("click",()=>{r.classList.toggle("choices__box--open"),t.forEach(s=>{s!==e&&s.querySelector(".choices__box").classList.contains("choices__box--open")&&s.querySelector(".choices__box").classList.remove("choices__box--open")}),h(r)}),window.addEventListener("resize",_(()=>{h(r)})),l.subscribe(()=>h(r)),document.addEventListener("click",({target:s})=>{s.closest(".choices")||t.forEach(i=>{i.querySelector(".choices__box").classList.remove("choices__box--open")})})})},o=(t,e={},...n)=>{if(e=e||{},typeof t=="function")return t(e,...n);const r=document.createElement(t);return Object.entries(e).forEach(([s,c])=>{s==="class"?r.classList.add(...c.trim().split(" ")):s.startsWith("on")&&s.toLowerCase()in window?r.addEventListener(s.toLowerCase().substring(2),c):s==="style"&&typeof c=="object"?Object.assign(r.style,c):r.setAttribute(s,c)}),n.forEach(s=>{typeof s=="string"||typeof s=="number"?r.append(document.createTextNode(s.toString())):Array.isArray(s)?s.forEach(c=>r.append(c)):r.append(s)}),r},O=t=>o("li",{class:"cart__item"},o("img",{class:"cart__image",src:`${u}${t.photoUrl}`,alt:t.name}),o("h4",{class:"cart__item-title"}," ",t.name," "),o("div",{class:"cart__counter"},o("button",{onClick:()=>{a.postCart({id:t.id,quantity:t.quantity-1})}}," - "),o("input",{class:"cart__counter-input",type:"number",min:"0",max:"99",value:t.quantity,onInput:_(({target:e})=>{a.postCart({id:t.id,quantity:isNaN(parseInt(e.value))?t.quantity:parseInt(e.value)}),e.value=isNaN(parseInt(e.value))?parseInt(e.value):t.quantity},500)}),"        ",o("button",{onClick:()=>{a.postCart({id:t.id,quantity:t.quantity+1})}}," + ")),o("p",{class:"cart__price"}," ",t.price*t.quantity," ₽ ")),T=()=>{const t=document.querySelector(".cart__list"),e=document.querySelector(".cart__price--total"),n=()=>{const r=a.getCart();if(t.textContent="",r.length===0){const i=document.createElement("li");i.textContent="Корзина пуста",i.classList.add("cart__no-product"),t.append(i),e.textContent="0";return}const s=r.map(i=>O(i));t.append(...s),console.log("productCards ",s),console.log("...productCards ",...s);const c=r.reduce((i,d)=>i+d.price*d.quantity,0);e.innerHTML=`${c}&nbsp;₽`};a.subscribe(n),n()},g=document.querySelector(".header__cart-btn"),$=document.querySelector(".cart__close"),f=document.querySelector(".cart"),D=()=>{f.classList.toggle("cart--open"),f.classList.contains("cart--open")&&window.innerWidth>1360&&f.scrollIntoView({behavior:"smooth"})},I=async()=>{await a.init(),g.textContent=a.getCart().length,g.addEventListener("click",D),T(),a.subscribe(()=>{g.textContent=a.getCart().length}),$.addEventListener("click",()=>{f.classList.remove("cart--open")})},j=t=>o("li",{class:"goods__item"},o("article",{class:"goods__card card"},o("img",{class:"card__image",src:`${u}${t.photoUrl}`,alt:t.name}),o("div",{class:"card__content"},o("h3",{class:"card__title"}," ",t.name," "),o("div",{class:"card__footer"},o("p",{class:"card__date-delivery"}," сегодня в 14:00 "),o("button",{class:"card__button",onMouseEnter:e=>{e.target.textContent="В Корзину"},onMouseLeave:e=>{e.target.innerHTML=`${t.price}&nbsp;P`},onClick:()=>{a.addProductCart(t.id)}}," ",t.price," P "))))),k=()=>{const t=document.querySelector(".goods__list"),e=()=>{const n=l.getProducts();if(t.innerHTML="",n.length===0&&!l.loading){const r=document.createElement("li");r.classList.add("goods__no-product"),r.textContent="Товары не найдены",t.append(r)}else n.forEach(r=>{const s=j(r);t.append(s)})};l.subscribe(e),e()},H=t=>o("ul",{class:"filter__type-list"},t.map(e=>o("li",{class:"filter__type-item"},o("button",{class:"filter__type-btn",type:"button"}," ",e," ")))),F=()=>{const t=document.querySelector(".filter__choices--type"),e=document.querySelector(".filter__choices-box--type"),n=()=>{const r=l.getCategories();if(console.log("categories from initChoicesType ",r),r.size){t.style.display="",e.textContent="";const s=H([...r]);console.log("listType ",s),e.append(s)}else t.style.display="none"};l.subscribe(n),n()},C=async(t,e,...n)=>{const r=document.createElement("div");r.classList.add("preload"),t.append(r),t.style.position="relative",r.style.display="flex";try{return await e(...n)}finally{r.style.display="none",r.remove(),t.style.position=""}},N=()=>{const t=document.querySelector(".filter__form"),e=document.querySelector(".goods__title"),n=document.querySelector(".goods"),r=c=>{const i=new FormData(t),d=i.get("type"),y=i.get("minPrice");console.log("minPrice: ",y);const m=i.get("maxPrice");console.log("maxPrice: ",m);const p={};d&&(p.type=d),y&&(p.minPrice=y),m&&(p.maxPrice=m),c&&(p.category=c),console.log("params: ",p),C(n,l.fetchProducts(),p)};r();const s=_(r,500);t.addEventListener("input",c=>{const i=c.target;if(i.name==="type"){e.textContent=i.labels[0].textContent,t.maxPrice.value="",t.minPrice.value="",r();return}(i.name==="minPrice"||i.name==="maxPrice")&&s()}),t.addEventListener("click",({target:c})=>{c.closest(".filter__type-btn")&&r(c.textContent)})},M=()=>{const t=document.querySelector(".header__form"),e=document.querySelector(".goods__title"),n=document.querySelector(".goods");t.addEventListener("submit",r=>{r.preventDefault();const c=new FormData(t).get("search").trim();c&&(e.textContent="Результаты поиска",C(n,l.fetchProducts(),{search:c}))})},W=()=>{document.querySelector(".order__select-wrapper").classList.add("order__select-wrapper--active")},A=()=>{document.querySelector(".order__select-wrapper").classList.remove("order__select-wrapper--active")},B=t=>{const e=new Date;e.setDate(e.getDate()+1);const n=e.getDate()<10?`0${e.getDate()}`:e.getDate(),r=e.getMonth()+1<10?`0${e.getMonth()+1}`:e.getMonth()+1,s=`${n}.${r}`;return o("div",{class:"order"},o("div",{class:"order__wrapper"},o("h2",{class:"order__title"}," Оформить заказ "),o("form",{class:"order__form",id:"order"},o("fieldset",{class:"order__fieldset"},o("legend",{class:"order__legend"},"Данные заказчика"),o("div",{class:"order__input-group"},o("input",{class:"order__input",type:"text",name:"name-buyer",placeholder:"Имя"}),o("input",{class:"order__input",type:"tel",name:"phone-buyer",placeholder:"Телефон"}))),o("fieldset",{class:"order__fieldset"},o("legend",{class:"order__legend"},"Данные получателя"),o("div",{class:"order__input-group"},o("input",{class:"order__input",type:"text",name:"name-recipient",placeholder:"Имя"}),o("input",{class:"order__input",type:"tel",name:"phone-recipient",placeholder:"Телефон"}))),o("fieldset",{class:"order__fieldset"},o("legend",{class:"order__legend"},"Адрес"),o("div",{class:"order__input-group"},o("input",{class:"order__input",type:"text",name:"street",placeholder:"Улица"}),o("input",{class:"order__input order__input--min",type:"number",name:"house",placeholder:"Дом"}),o("input",{class:"order__input order__input--min",type:"number",name:"apartment",placeholder:"Квартира"}))),o("fieldset",{class:"order__fieldset"},o("div",{class:"order__payment"},o("label",{class:"order__label-radio"},o("input",{class:"order__radio",type:"radio",name:"payment-online",value:"true",checked:!0})," Оплата онлайн")),o("div",{class:"order__delivery"},o("label",{for:"delivery"},"Доставка ",s),o("input",{type:"hidden",name:"delivery-date",value:s}),o("div",{class:"order__select-wrapper"},o("select",{class:"order__select",name:"delivery-time",id:"delivery",onFocus:W,onBlur:A},o("option",{value:"9-12"},"с 9:00 до 12:00"),o("option",{value:"12-15"},"с 12:00 до 15:00"),o("option",{value:"15-18"},"с 15:00 до 18:00"),o("option",{value:"18-21"},"с 18:00 до 21:00")))))),o("div",{class:"order__footer"},o("p",{class:"order__total-price"},t," ₽"),o("button",{class:"order__button",type:"submit",form:"order"},"Заказать"))),o("button",{class:"order__close",type:"button"},"×"))},R=t=>o("div",{class:"order__wrapper"},o("h2",{class:"order__title"}," Заказ оформлен "),o("p",null," Ваш номер заказа ",t," ")),b=document.querySelector(".cart__order-btn"),U=document.querySelector(".cart"),V=()=>{const t=a.getCart();console.log("cart in openOrder: ",t);const e=t.reduce((s,c)=>s+c.price*c.quantity,0),n=B(e);document.body.append(n),document.querySelector(".order").style.display="flex",n.addEventListener("click",({target:s})=>{console.log("target:  ",s),(s===n||s.closest(".order__close"))&&n.remove()});const r=document.querySelector(".order__form");r.addEventListener("submit",async s=>{s.preventDefault();const c=new FormData(r),i={buyer:{name:c.get("name-buyer"),phone:c.get("phone-buyer")},recipient:{name:c.get("name-recipient"),phone:c.get("phone-recipient")},address:`ул. ${c.get("street")}, дом ${c.get("house")}, кв ${c.get("apartment")}`,paymentOnline:`${c.get("payment-online")==="true"}`,deliveryDate:c.get("delivery-date"),deliveryTime:c.get("delivery-time")};console.log("cartStore до отправки формы : ",a);const d=await x(i),y=R(d.orderId);n.textContent="",n.append(y),a.clearCart(),U.classList.remove("cart__open")})},z=()=>{const t=()=>{const e=a.getCart();console.log("cart in initOrder: ",e),e.length===0?b.disabled=!0:b.disabled=!1};a.subscribe(t),b.addEventListener("click",V)},X=()=>{w(),P(),F(),I(),M(),N(),k(),z()};X();
